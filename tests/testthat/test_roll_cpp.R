context("Testing `roll_cpp`")

test_that("`roll_cpp` works w/o missing values", {
  roll_regress_R_for_loop <- function(X, y, width){
    n <- nrow(X)
    p <- ncol(X)
    out <- matrix(NA_real_, n, p)

    for(i in width:n){
      idx <- (i - width + 1L):i
      out[i, ] <- lm.fit(X[idx, , drop = FALSE], y[idx])$coefficients
    }

    out
  }

  # set.seed(101)
  # n <- 100
  # p <- 3
  # X <- matrix(rnorm(p * n), n, p)
  # y <- drop(X %*% runif(p)) + rnorm(n)
  # dput(round(X, 3))
  # dput(round(y, 3))
  wdth <- 40
  X <- structure(c(
    -0.326, 0.552, -0.675, 0.214, 0.311, 1.174, 0.619,
    -0.113, 0.917, -0.223, 0.526, -0.795, 1.428, -1.467, -0.237,
    -0.193, -0.85, 0.058, -0.818, -2.05, -0.164, 0.709, -0.268, -1.464,
    0.744, -1.41, 0.467, -0.119, 0.467, 0.498, 0.895, 0.279, 1.008,
    -2.073, 1.19, -0.724, 0.168, 0.92, -1.672, 0.448, 0.482, 0.758,
    -2.319, -0.46, -1.105, 0.403, 0.569, -0.706, -0.29, -1.484, -1.15,
    -0.274, 0.578, -1.397, 0.749, -1.051, 0.165, 1.13, 1.174, -0.428,
    -0.26, -1.411, -0.641, 0.112, 0.423, 0.387, -0.688, 0.149, -0.058,
    -0.075, 1.51, 1.62, 1.153, -0.078, -1.819, -1.037, 0.302, -1.278,
    0.138, -0.051, 1.852, 1.112, -0.511, -0.544, -1.729, 0.471, 0.005,
    1.348, 0.724, 1.553, 1.325, -0.034, -0.361, -0.72, 0.282, -0.791,
    -0.445, 1.365, 0.497, -0.814, 0.268, -0.592, 2.133, 1.173, 0.747,
    -0.231, 0.088, -2.184, -0.467, 1.686, -0.568, -0.047, -0.157,
    1.602, 0.769, -0.772, -0.631, -0.83, -0.591, 0.981, -0.662, -0.772,
    -2.018, -0.534, 0.435, -0.771, -0.754, -0.299, 1.664, -1.244,
    -0.783, 0.245, -0.144, -1.609, 0.952, -1.819, 1.784, 1.887, 1.491,
    -0.381, -0.909, -0.338, -1.412, 0.218, 0.67, -0.288, 0.469, -0.47,
    -0.239, -0.447, -0.619, 0.253, -0.753, 0.732, -0.403, -2.823,
    0.463, 2.133, -0.27, 0.249, 0.038, 0.394, -1.504, -1.587, -0.927,
    0.776, -0.781, -1.279, -0.001, -1.851, 0.452, -0.433, 0.714,
    0.961, 0.382, 1.218, -0.017, -0.038, 1.244, -0.956, 0.915, -0.939,
    0.112, 0.553, 0.532, -0.874, -0.187, -0.214, -0.204, 1.72, 0.202,
    0.513, 1.452, 0.364, -0.876, -0.015, -0.724, 1.969, -0.536, -0.026,
    -0.164, -1.383, 0.424, -0.79, 1.21, 0.895, -0.101, 0.297, 0.197,
    -0.157, 1.537, -2.168, 0.598, 0.043, 1.295, 0.706, 0.346, -0.08,
    0.455, 1.276, 1.265, 0.269, -0.121, 0.795, -0.514, -0.407, 1.22,
    0.084, 0.59, -0.517, 0.769, 0.802, -0.697, 1.178, 0.586, -0.467,
    0.386, -0.535, 1.057, -0.206, 0.607, -0.548, -2.1, 0.251, -0.055,
    -0.66, -1.456, 0.024, 0.548, -0.809, -0.239, -0.353, 0.82, -0.345,
    -1.183, -1.031, -0.075, 0.829, -1.036, -0.147, -0.281, -1.374,
    1.558, -0.575, 2.187, 0.794, 0.203, -0.022, 0.305, -1.109, 0.765,
    -0.022, -0.904, 0.4, -1.149, 0.188, 0.217, -1.049, -0.075, -1.568,
    -1.174, -2.148, 0.342, 0.905, 1.096, -1.471, -0.281, 0.846, -1.286,
    -0.312, -0.363, 1.412, -0.255, 0.387, 0.525, 0.615, -0.333, 0.745,
    -0.311, -0.234), .Dim = c(100L, 3L))
  y <- c(
     -0.162, -1.562, 0.805, -0.611, 0.787, -1.146, -0.569, -0.914,
     0.372, 0.398, 1.033, 0.009, 0.439, 0.967, 0.249, -0.978, -0.853,
     -2.209, -0.721, 1.521, 2.914, -2.086, -4.518, 0.653, 0.802, -1.308,
     -0.759, -1.235, 2.379, -0.188, 1.192, 0.342, 2.513, -0.145, 0.874,
     -0.492, 0.423, 1.248, 0.445, -0.459, 0.19, 1.269, -0.611, -0.167,
     1.112, -0.422, 1.795, -1.979, -1.497, -1.009, -2.166, -0.41,
     0.65, 2.016, 1.24, -0.518, -0.564, 0.123, -0.849, -1.199, -1.076,
     0.539, -0.558, -1.474, 0.691, 1.205, 0.859, -0.564, 0.152, -2.522,
     1.242, 0.891, -0.545, 0.936, 0.286, 0.032, 0.748, -1.623, -0.145,
     -2.159, 0.752, -2.578, 1.022, 1.759, 0.59, -2.389, -0.953, 2.007,
     1.262, -0.16, -0.349, 0.617, 0.445, -1.548, -1.48, -1.067, -0.739,
     1.373, -0.834, -0.656)
  wdth = 40

  expect_equal(
    roll_regress_R_for_loop(X, y, wdth), roll_cpp(Y = y, X = X, window = wdth))
})
